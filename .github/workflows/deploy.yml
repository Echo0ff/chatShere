# ChatSphere CI/CD Pipeline
name: ğŸš€ ChatSphere CI/CD

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# ç¯å¢ƒå˜é‡
env:
  REGISTRY: docker.io
  BACKEND_IMAGE: ${{ secrets.DOCKER_USERNAME }}/chatsphere-backend
  FRONTEND_IMAGE: ${{ secrets.DOCKER_USERNAME }}/chatsphere-frontend
  SERVER_IP: 49.232.202.209
  SERVER_PORT: 8999

jobs:
  # åŸºç¡€éªŒè¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
  validate:
    name: âœ… Validate Build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: éªŒè¯å‰ç«¯æ„å»º
      working-directory: ./frontend
      run: |
        npm install
        npm run build
        echo "âœ… å‰ç«¯æ„å»ºéªŒè¯é€šè¿‡"

    - name: éªŒè¯åç«¯ä¾èµ–
      working-directory: ./backend
      run: |
        pip install uv
        uv sync --no-dev
        echo "âœ… åç«¯ä¾èµ–éªŒè¯é€šè¿‡"

  # æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
  build-and-push:
    name: ğŸ³ Build & Push Images
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½• Docker Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: æ„å»ºå¹¶æ¨é€åç«¯é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        target: production
        platforms: linux/amd64
        push: true
        tags: ${{ env.BACKEND_IMAGE }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: æ„å»ºå¹¶æ¨é€å‰ç«¯é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        target: production
        platforms: linux/amd64
        push: true
        tags: ${{ env.FRONTEND_IMAGE }}:latest
        build-args: |
          VITE_API_URL=http://${{ env.SERVER_IP }}:${{ env.SERVER_PORT }}
          VITE_WS_URL=ws://${{ env.SERVER_IP }}:${{ env.SERVER_PORT }}
          VITE_APP_NAME=ChatSphere
          VITE_ENVIRONMENT=production
          VITE_DEBUG=false
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # æµ‹è¯•ç¯å¢ƒéƒ¨ç½²ï¼ˆæš‚æ—¶æ³¨é‡Šï¼‰
  # deploy-testing:
  #   name: ğŸ§ª Deploy to Testing
  #   runs-on: ubuntu-latest
  #   needs: build-and-push
  #   if: github.ref == 'refs/heads/develop'
  #   environment: testing
  #   steps:
  #   - name: éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
  #     run: echo "æµ‹è¯•ç¯å¢ƒéƒ¨ç½²æš‚æ—¶ç¦ç”¨"

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
    - name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ env.SERVER_IP }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          echo "ğŸš€ å¼€å§‹ ChatSphere ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."

          # è¿›å…¥éƒ¨ç½²ç›®å½•
          cd /data/chatsphere

          # æ£€æŸ¥ Docker Compose å‘½ä»¤
          if command -v docker-compose &> /dev/null; then
            DOCKER_COMPOSE_CMD="docker-compose"
          else
            DOCKER_COMPOSE_CMD="docker compose"
          fi
          echo "ğŸ³ ä½¿ç”¨ Docker Compose å‘½ä»¤: $DOCKER_COMPOSE_CMD"

          # ç™»å½• Docker Registry
          echo "ğŸ” ç™»å½• Docker Registry..."
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

          # æ‹‰å–æœ€æ–°é•œåƒ
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
          $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml pull backend frontend

          # é‡æ–°å¯åŠ¨æœåŠ¡
          echo "ğŸ”„ é‡æ–°å¯åŠ¨æœåŠ¡..."
          $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml down
          $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml up -d

          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 60

          # å¥åº·æ£€æŸ¥
          echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
          for i in {1..10}; do
            if curl -f http://localhost:${{ env.SERVER_PORT }}/health &>/dev/null; then
              echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
              $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml logs --tail=20
              exit 1
            fi
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/10)"
            sleep 10
          done

          # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
          echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
          $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml ps

          # æ¸…ç†æ—§é•œåƒ
          echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
          docker image prune -f

          echo "ğŸ‰ éƒ¨ç½²å®Œæˆ!"
          echo "ğŸŒ è®¿é—®åœ°å€: http://${{ env.SERVER_IP }}:${{ env.SERVER_PORT }}"

  # éƒ¨ç½²åé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
  # notify:
  #   name: ğŸ“¢ Notify
  #   runs-on: ubuntu-latest
  #   needs: [deploy-production]
  #   if: always()
  #   steps:
  #   - name: å‘é€éƒ¨ç½²é€šçŸ¥
  #     run: echo "éƒ¨ç½²é€šçŸ¥åŠŸèƒ½æš‚æ—¶ç¦ç”¨"
